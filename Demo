const multer = require('multer');
const XLSX = require('xlsx');
const upload = multer({ dest: 'uploads/' });

app.post("/upload", upload.single('file'), (req, res) => {
  try {
    const workbook = XLSX.readFile(req.file.path);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);
    const openRecords = data.filter(row => row.status === 'open');
    
    // Insert each record into Assessments table
    openRecords.forEach(record => {
      const query = `INSERT INTO assessments (filename, filepath, uploaded_by, uploaded_date, file_size, ${Object.keys(record).join(',')}) VALUES (?, ?, ?, ?, ?, ${Object.values(record).map(() => '?').join(',')})`;
      // Execute query with your DB connection
    });
    
    res.json({message: "Success", count: openRecords.length});
  } catch(err) {
    res.status(500).json({error: err.message});
  }
});
